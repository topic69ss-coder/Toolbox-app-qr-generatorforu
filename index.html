<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Toolbox - QR Generator</title>

<!-- qrcodejs for client-side QR generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,Arial,system-ui}
  body{background:#f2f3f7;min-height:100vh;padding-bottom:120px}
  header{position:sticky;top:0;background:#fff;padding:14px;text-align:center;font-weight:700;font-size:18px;box-shadow:0 2px 8px rgba(0,0,0,0.06);z-index:60}

  .app{max-width:720px;margin:0 auto;padding:12px}
  .screen{display:none}
  .screen.active{display:block}

  .card{background:#fff;border-radius:12px;padding:16px;margin:14px 0;box-shadow:0 6px 20px rgba(2,6,23,0.05)}
  input,select,button{width:100%;padding:12px;margin-top:8px;border-radius:10px;border:1px solid #e6e6e6}
  button{background:#6c63ff;color:#fff;border:none;font-weight:700;cursor:pointer}
  .muted{color:#666;font-size:13px;margin-top:8px}
  #qrPreview{margin-top:12px;background:#fff;border-radius:10px;height:260px;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(2,6,23,0.04);overflow:hidden}
  #qrPreview img, #qrPreview canvas{max-width:90%;max-height:90%}

  .three-dots{position:fixed;right:12px;top:12px;z-index:70}
  .three-dots button{width:42px;height:42px;border-radius:10px;border:none;background:rgba(0,0,0,0.06);font-size:20px;cursor:pointer}
  .menu-popup{position:fixed;right:12px;top:62px;width:220px;background:#fff;border-radius:10px;padding:8px;box-shadow:0 12px 30px rgba(2,6,23,0.12);display:none;z-index:71}
  .menu-popup a, .menu-popup button{display:block;padding:8px 10px;border-radius:8px;text-align:left;background:transparent;border:none;color:#222;text-decoration:none;margin:4px 0;cursor:pointer}

  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:72}
  .modal{background:#fff;padding:16px;border-radius:12px;width:92%;max-width:420px}
  .small{font-size:13px;color:#666}

  .note{color:#b22;margin-top:10px;text-align:center}

  /* bottom nav */
  .bottom-nav{position:fixed;left:0;right:0;bottom:0;height:72px;background:#fff;border-top:1px solid #eee;display:flex;z-index:65}
  .nav-item{flex:1;text-align:center;padding-top:8px;font-size:12px;color:#666;cursor:pointer}
  .nav-item span{display:block;font-size:20px}
  .nav-item.active{color:#6c63ff;font-weight:700}

  .ad-wrap{width:320px;max-width:95%;text-align:center;margin-top:12px}
  @media(min-width:900px){ .app{padding:18px} }
  /* calculator tweaks */
  .display{background:#111;color:#fff;padding:12px;border-radius:10px;font-size:22px;text-align:right;white-space:nowrap;overflow-x:auto}
  .keys{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px}
  .key{background:#fff;padding:14px;border-radius:8px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,0.05);cursor:pointer;user-select:none}
  .op{background:#6c63ff;color:#fff}
</style>
</head>
<body>

<header id="title">Toolbox - QR Generator</header>

<!-- three-dots menu -->
<div class="three-dots">
  <button id="dotsBtn">‚ãÆ</button>
  <div class="menu-popup" id="dotsMenu" role="menu" aria-hidden="true">
    <a href="#" id="menuAbout">About</a>
    <button id="menuInstagram">Instagram</button>
  </div>
</div>

<!-- About Modal -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>About Toolbox - QR Generator</h3>
    <p class="small"><strong>Developer:</strong> Saikiran</p>
    <p class="small"><strong>Instagram:</strong> @saikiran.jinde_2706</p>
    <p class="small" style="margin-top:10px">Compact mobile-first toolbox with calculator, converters (weight, distance, area, speed, temperature), and QR generator. Ads placed in each section.</p>
    <div style="margin-top:12px;text-align:right">
      <button id="closeModal" style="background:#ddd;color:#111;border-radius:8px;padding:8px 12px;border:none">Close</button>
    </div>
  </div>
</div>

<div class="app">

  <!-- Calculator -->
  <section id="screen-calc" class="screen active">
    <div class="card">
      <div class="display" id="calcDisplay">0</div>
      <div class="keys" id="calcKeys" role="group" aria-label="calculator keys">
        <div class="key">7</div><div class="key">8</div><div class="key">9</div><div class="key op">/</div>
        <div class="key">4</div><div class="key">5</div><div class="key">6</div><div class="key op">*</div>
        <div class="key">1</div><div class="key">2</div><div class="key">3</div><div class="key op">-</div>
        <div class="key">0</div><div class="key">.</div><div class="key" id="clear">C</div><div class="key op">+</div>
        <div class="key op" id="equals" style="grid-column:span 4;background:#ff6b6b">=</div>
      </div>

      <!-- banner ad for this section -->
      <div class="ad-wrap" aria-hidden="false">
        <script type="text/javascript">
            atOptions = {
                'key' : 'c533f92842a99236b1cb6736b289861e',
                'format' : 'iframe',
                'height' : 50,
                'width' : 320,
                'params' : {}
            };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/c533f92842a99236b1cb6736b289861e/invoke.js"></script>
      </div>
    </div>
  </section>

  <!-- Weight (extended units) -->
  <section id="screen-weight" class="screen">
    <div class="card">
      <h3>Weight Converter</h3>
      <input id="wValue" type="number" placeholder="Enter value">
      <select id="wFrom">
        <option value="kg">Kg</option>
        <option value="g">Gram</option>
        <option value="lb">Pound</option>
        <option value="oz">Ounce</option>
        <option value="tonne">Tonne</option>
      </select>
      <select id="wTo">
        <option value="g">Gram</option>
        <option value="kg">Kg</option>
        <option value="lb">Pound</option>
        <option value="oz">Ounce</option>
        <option value="tonne">Tonne</option>
      </select>
      <button onclick="convertWeight()">Convert</button>
      <p id="wResult" class="muted"></p>

      <!-- banner ad for this section -->
      <div class="ad-wrap" aria-hidden="false">
        <script type="text/javascript">
            atOptions = {
                'key' : 'c533f92842a99236b1cb6736b289861e',
                'format' : 'iframe',
                'height' : 50,
                'width' : 320,
                'params' : {}
            };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/c533f92842a99236b1cb6736b289861e/invoke.js"></script>
      </div>
    </div>
  </section>

  <!-- Currency -->
  <section id="screen-currency" class="screen">
    <div class="card">
      <h3>Currency Converter</h3>
      <input id="cValue" type="number" placeholder="Amount">
      <select id="cFrom"><option>INR</option><option>USD</option></select>
      <select id="cTo"><option>USD</option><option>INR</option></select>
      <button onclick="convertCurrency()">Convert</button>
      <p id="cResult" class="muted"></p>

      <!-- banner ad for this section -->
      <div class="ad-wrap" aria-hidden="false">
        <script type="text/javascript">
            atOptions = {
                'key' : 'c533f92842a99236b1cb6736b289861e',
                'format' : 'iframe',
                'height' : 50,
                'width' : 320,
                'params' : {}
            };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/c533f92842a99236b1cb6736b289861e/invoke.js"></script>
      </div>
    </div>
  </section>

  <!-- Distance (extended units) -->
  <section id="screen-distance" class="screen">
    <div class="card">
      <h3>Distance Converter</h3>
      <input id="dValue" type="number" placeholder="Value">
      <select id="dFrom">
        <option value="km">Kilometer</option>
        <option value="m">Meter</option>
        <option value="mile">Mile</option>
        <option value="yd">Yard</option>
        <option value="ft">Foot</option>
      </select>
      <select id="dTo">
        <option value="m">Meter</option>
        <option value="km">Kilometer</option>
        <option value="mile">Mile</option>
        <option value="yd">Yard</option>
        <option value="ft">Foot</option>
      </select>
      <button onclick="convertDistance()">Convert</button>
      <p id="dResult" class="muted"></p>

      <!-- banner ad for this section -->
      <div class="ad-wrap" aria-hidden="false">
        <script type="text/javascript">
            atOptions = {
                'key' : 'c533f92842a99236b1cb6736b289861e',
                'format' : 'iframe',
                'height' : 50,
                'width' : 320,
                'params' : {}
            };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/c533f92842a99236b1cb6736b289861e/invoke.js"></script>
      </div>
    </div>
  </section>

  <!-- Area (NEW) -->
  <section id="screen-area" class="screen">
    <div class="card">
      <h3>Area Converter</h3>
      <input id="aValue" type="number" placeholder="Enter value">
      <select id="aFrom">
        <option value="m2">Square metre (m¬≤)</option>
        <option value="km2">Square kilometre (km¬≤)</option>
        <option value="ft2">Square foot (ft¬≤)</option>
        <option value="yd2">Square yard (yd¬≤)</option>
        <option value="acre">Acre</option>
        <option value="hectare">Hectare</option>
      </select>
      <select id="aTo">
        <option value="m2">Square metre (m¬≤)</option>
        <option value="km2">Square kilometre (km¬≤)</option>
        <option value="ft2">Square foot (ft¬≤)</option>
        <option value="yd2">Square yard (yd¬≤)</option>
        <option value="acre">Acre</option>
        <option value="hectare">Hectare</option>
      </select>
      <button onclick="convertArea()">Convert</button>
      <p id="aResult" class="muted"></p>

      <!-- banner ad -->
      <div class="ad-wrap" aria-hidden="false">
        <script type="text/javascript">
            atOptions = {
                'key' : 'c533f92842a99236b1cb6736b289861e',
                'format' : 'iframe',
                'height' : 50,
                'width' : 320,
                'params' : {}
            };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/c533f92842a99236b1cb6736b289861e/invoke.js"></script>
      </div>
    </div>
  </section>

  <!-- Speed (NEW) -->
  <section id="screen-speed" class="screen">
    <div class="card">
      <h3>Speed Converter</h3>
      <input id="sValue" type="number" placeholder="Enter value">
      <select id="sFrom">
        <option value="mps">m/s</option>
        <option value="kph">km/h</option>
        <option value="mph">mph</option>
        <option value="knot">knot</option>
      </select>
      <select id="sTo">
        <option value="mps">m/s</option>
        <option value="kph">km/h</option>
        <option value="mph">mph</option>
        <option value="knot">knot</option>
      </select>
      <button onclick="convertSpeed()">Convert</button>
      <p id="sResult" class="muted"></p>

      <!-- banner ad -->
      <div class="ad-wrap" aria-hidden="false">
        <script type="text/javascript">
            atOptions = {
                'key' : 'c533f92842a99236b1cb6736b289861e',
                'format' : 'iframe',
                'height' : 50,
                'width' : 320,
                'params' : {}
            };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/c533f92842a99236b1cb6736b289861e/invoke.js"></script>
      </div>
    </div>
  </section>

  <!-- Temperature (NEW) -->
  <section id="screen-temp" class="screen">
    <div class="card">
      <h3>Temperature Converter</h3>
      <input id="tValue" type="number" placeholder="Enter value">
      <select id="tFrom">
        <option value="c">Celsius (¬∞C)</option>
        <option value="f">Fahrenheit (¬∞F)</option>
        <option value="k">Kelvin (K)</option>
      </select>
      <select id="tTo">
        <option value="c">Celsius (¬∞C)</option>
        <option value="f">Fahrenheit (¬∞F)</option>
        <option value="k">Kelvin (K)</option>
      </select>
      <button onclick="convertTemp()">Convert</button>
      <p id="tResult" class="muted"></p>

      <!-- banner ad -->
      <div class="ad-wrap" aria-hidden="false">
        <script type="text/javascript">
            atOptions = {
                'key' : 'c533f92842a99236b1cb6736b289861e',
                'format' : 'iframe',
                'height' : 50,
                'width' : 320,
                'params' : {}
            };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/c533f92842a99236b1cb6736b289861e/invoke.js"></script>
      </div>
    </div>
  </section>

  <!-- QR Generator -->
  <section id="screen-qr" class="screen">
    <div class="card">
      <h3>QR Generator</h3>
      <input id="qrText" placeholder="Enter text/URL">
      <input id="qrFile" type="file" accept="*/*" />
      <div style="display:flex;gap:10px;margin-top:6px">
        <button id="makeQR" style="flex:1">Generate QR</button>
        <button id="downloadQR" style="flex:1;background:#ff6b6b">Download</button>
      </div>

      <div id="qrPreview">No QR yet</div>
      <p id="qrMsg" class="muted" style="margin-top:10px;color:#b33"></p>
      <p id="thank" style="display:none;margin-top:10px;font-weight:700;color:#0a7f45;">Thank you for using toolbox-qr generator</p>

      <!-- banner ad -->
      <div class="ad-wrap" aria-hidden="false">
        <script type="text/javascript">
            atOptions = {
                'key' : 'c533f92842a99236b1cb6736b289861e',
                'format' : 'iframe',
                'height' : 50,
                'width' : 320,
                'params' : {}
            };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/c533f92842a99236b1cb6736b289861e/invoke.js"></script>
      </div>
    </div>
  </section>

</div>

<!-- bottom nav -->
<div class="bottom-nav" id="bottomNav">
  <div class="nav-item active" data-target="calc"><span>üßÆ</span>Calc</div>
  <div class="nav-item" data-target="weight"><span>‚öñÔ∏è</span>Weight</div>
  <div class="nav-item" data-target="currency"><span>üí±</span>Currency</div>
  <div class="nav-item" data-target="distance"><span>üìè</span>Distance</div>
  <div class="nav-item" data-target="area"><span>üìê</span>Area</div>
  <div class="nav-item" data-target="speed"><span>üöó</span>Speed</div>
  <div class="nav-item" data-target="temp"><span>üå°Ô∏è</span>Temp</div>
  <div class="nav-item" data-target="qr"><span>üì∑</span>QR</div>
</div>

<script>
/* ---------- Navigation ---------- */
const navItems = document.querySelectorAll('.nav-item');
function showScreen(key){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('screen-' + key).classList.add('active');
  document.getElementById('title').textContent = {
    calc:'Calculator', weight:'Weight Converter', currency:'Currency Converter', distance:'Distance Converter',
    area:'Area Converter', speed:'Speed Converter', temp:'Temperature Converter', qr:'QR Generator'
  }[key];
  navItems.forEach(n=>n.classList.toggle('active', n.getAttribute('data-target')===key));
}
navItems.forEach(item=>item.addEventListener('click', ()=> showScreen(item.getAttribute('data-target'))));

/* ---------- Three-dots menu ---------- */
const dotsBtn=document.getElementById('dotsBtn'), dotsMenu=document.getElementById('dotsMenu'), modal=document.getElementById('modalBackdrop');
dotsBtn.onclick=e=>{ e.stopPropagation(); dotsMenu.style.display=(dotsMenu.style.display==='block')? 'none':'block'; };
document.addEventListener('click', ()=> dotsMenu.style.display='none');
document.getElementById('menuAbout').addEventListener('click', e=>{ e.preventDefault(); modal.style.display='flex'; dotsMenu.style.display='none'; });
document.getElementById('closeModal').addEventListener('click', ()=> modal.style.display='none');
document.getElementById('menuInstagram').addEventListener('click', ()=> window.open('https://instagram.com/saikiran.jinde_2706','_blank') );

/* ---------- Calculator (fixed) ---------- */
let calc = "", display = document.getElementById('calcDisplay');
function isOperator(ch){ return ["+","-","*","/"].includes(ch); }
function lastChar(){ return calc.length ? calc[calc.length-1] : ''; }
function lastNumberSegment(){ const idx = Math.max(calc.lastIndexOf('+'), calc.lastIndexOf('-'), calc.lastIndexOf('*'), calc.lastIndexOf('/')); return calc.slice(idx+1); }

document.getElementById("calcKeys").addEventListener("click",(e)=>{
  const el = e.target; if(!el.classList.contains('key')) return;
  const key = el.innerText.trim();
  if(key === "C"){ calc = ""; display.textContent = "0"; return; }
  if(key === "="){ if(!calc) return; const safe = calc.replace(/[^0-9+\-*/().]/g,''); try{ const res = Function('"use strict";return ('+safe+')')(); calc = (res === undefined ? '' : String(res)); display.textContent = calc; }catch(err){ display.textContent = "Error"; calc = ""; } return; }
  if(isOperator(key)){ if(!calc){ if(key === "-"){ calc = "-"; display.textContent = calc; } return; } if(isOperator(lastChar())){ calc = calc.slice(0, -1) + key; } else { calc += key; } display.textContent = calc; return; }
  if(key === "."){ const segment = lastNumberSegment(); if(segment.includes(".")) return; if(segment === "") calc += "0."; else calc += "."; display.textContent = calc; return; }
  // number
  calc += key; if(calc.length > 40) calc = calc.slice(-40); display.textContent = calc;
});

/* ---------- Converters implementations ---------- */

/* Weight: kg, g, lb, oz, tonne */
function convertWeight(){
  const v = Number(document.getElementById('wValue').value || 0);
  const from = document.getElementById('wFrom').value;
  const to = document.getElementById('wTo').value;

  // convert everything to grams then to target
  const toGrams = {
    'kg': v * 1000,
    'g': v,
    'lb': v * 453.59237,
    'oz': v * 28.349523125,
    'tonne': v * 1000000
  }[from];

  const out = {
    'kg': toGrams / 1000,
    'g': toGrams,
    'lb': toGrams / 453.59237,
    'oz': toGrams / 28.349523125,
    'tonne': toGrams / 1000000
  }[to];

  document.getElementById('wResult').textContent = `${v} ${from} = ${out.toFixed(6).replace(/\.?0+$/,"")} ${to}`;
}

/* Currency: simple INR <-> USD approximation (you can replace rates later) */
function convertCurrency(){
  const v = Number(document.getElementById('cValue').value || 0);
  const f = document.getElementById('cFrom').value;
  const t = document.getElementById('cTo').value;
  // example static rate; replace with dynamic fetch for real app
  const rate = 83; // 1 USD = 83 INR (approx)
  const usd = f === "INR" ? v / rate : v;
  const out = t === "INR" ? usd * rate : usd;
  document.getElementById('cResult').textContent = `${v} ${f} = ${out.toFixed(3).replace(/\.?0+$/,"")} ${t}`;
}

/* Distance: km, m, mile, yd, ft */
function convertDistance(){
  const v = Number(document.getElementById('dValue').value || 0);
  const from = document.getElementById('dFrom').value;
  const to = document.getElementById('dTo').value;

  // to meters
  const toMeters = {
    'km': v * 1000,
    'm': v,
    'mile': v * 1609.344,
    'yd': v * 0.9144,
    'ft': v * 0.3048
  }[from];

  const out = {
    'km': toMeters / 1000,
    'm': toMeters,
    'mile': toMeters / 1609.344,
    'yd': toMeters / 0.9144,
    'ft': toMeters / 0.3048
  }[to];

  document.getElementById('dResult').textContent = `${v} ${from} = ${out.toFixed(6).replace(/\.?0+$/,"")} ${to}`;
}

/* Area: m2, km2, ft2, yd2, acre, hectare */
function convertArea(){
  const v = Number(document.getElementById('aValue').value || 0);
  const from = document.getElementById('aFrom').value;
  const to = document.getElementById('aTo').value;

  // convert to square meters
  const toM2 = {
    'm2': v,
    'km2': v * 1e6,
    'ft2': v * 0.09290304,
    'yd2': v * 0.83612736,
    'acre': v * 4046.8564224,
    'hectare': v * 10000
  }[from];

  const out = {
    'm2': toM2,
    'km2': toM2 / 1e6,
    'ft2': toM2 / 0.09290304,
    'yd2': toM2 / 0.83612736,
    'acre': toM2 / 4046.8564224,
    'hectare': toM2 / 10000
  }[to];

  document.getElementById('aResult').textContent = `${v} ${from} = ${Number(out.toFixed(6)).toString()} ${to}`;
}

/* Speed: m/s, km/h, mph, knot */
function convertSpeed(){
  const v = Number(document.getElementById('sValue').value || 0);
  const from = document.getElementById('sFrom').value;
  const to = document.getElementById('sTo').value;

  // convert to m/s
  const toMps = {
    'mps': v,
    'kph': v / 3.6,
    'mph': v * 0.44704,
    'knot': v * 0.514444444
  }[from];

  const out = {
    'mps': toMps,
    'kph': toMps * 3.6,
    'mph': toMps / 0.44704,
    'knot': toMps / 0.514444444
  }[to];

  document.getElementById('sResult').textContent = `${v} ${from} = ${out.toFixed(6).replace(/\.?0+$/,"")} ${to}`;
}

/* Temperature: C, F, K */
function convertTemp(){
  const v = Number(document.getElementById('tValue').value || 0);
  const from = document.getElementById('tFrom').value;
  const to = document.getElementById('tTo').value;

  let c = 0;
  if(from === 'c') c = v;
  if(from === 'f') c = (v - 32) * (5/9);
  if(from === 'k') c = v - 273.15;

  let result = 0;
  if(to === 'c') result = c;
  if(to === 'f') result = (c * 9/5) + 32;
  if(to === 'k') result = c + 273.15;

  document.getElementById('tResult').textContent = `${v} ${from.toUpperCase()} = ${Number(result.toFixed(4))} ${to.toUpperCase()}`;
}

/* ---------- QR generation (client-side qrcodejs) + interstitial ---------- */
let qrDataURL = "", pendingContent = "", interstitialTimeout = null;
const qrPreview = document.getElementById('qrPreview');
const qrMsg = document.getElementById('qrMsg');
const thank = document.getElementById('thank');

function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=()=>rej(r.error); r.readAsDataURL(file); }); }

function renderQR(content){
  qrPreview.innerHTML=''; qrDataURL='';
  const holder = document.createElement('div'); qrPreview.appendChild(holder);
  let final = String(content||'');
  if(final.length > 1200) final = final.slice(0,900) + '...';
  try{
    const q = new QRCode(holder, { text: final, width:300, height:300, colorDark:"#000", colorLight:"#fff", correctLevel: QRCode.CorrectLevel.H });
    setTimeout(()=>{
      const canvas = holder.querySelector('canvas'), img = holder.querySelector('img');
      if(canvas){
        try{ qrDataURL = canvas.toDataURL('image/png'); const p=document.createElement('img'); p.src=qrDataURL; p.style.width='200px'; qrPreview.innerHTML=''; qrPreview.appendChild(p); thank.style.display='block'; qrMsg.textContent=''; }catch(e){ qrPreview.innerHTML='<div style="color:#b12727">QR generation failed</div>'; qrDataURL=''; }
      } else if(img){
        const tmp = new Image(); tmp.crossOrigin='anonymous';
        tmp.onload = function(){ try{ const c=document.createElement('canvas'); c.width=tmp.width; c.height=tmp.height; const ctx=c.getContext('2d'); ctx.drawImage(tmp,0,0); qrDataURL = c.toDataURL('image/png'); const p=document.createElement('img'); p.src=qrDataURL; p.style.width='200px'; qrPreview.innerHTML=''; qrPreview.appendChild(p); thank.style.display='block'; qrMsg.textContent=''; }catch(err){ qrPreview.innerHTML='<div style="color:#b12727">QR generation failed</div>'; qrDataURL=''; } };
        tmp.onerror = function(){ qrPreview.innerHTML='<div style="color:#b12727">QR generation failed</div>'; qrDataURL=''; };
        tmp.src = img.src;
      } else { qrPreview.innerHTML='<div style="color:#b12727">QR generation failed</div>'; qrDataURL=''; }
    },120);
  }catch(err){ qrPreview.innerHTML='<div style="color:#b12727">QR generation failed</div>'; qrDataURL=''; }
}

function showInterstitialThenGenerate(){
  if(!pendingContent){ qrMsg.textContent='Nothing to generate.'; return; }
  let interDiv = document.getElementById('interstitialBox');
  if(!interDiv){ interDiv = document.createElement('div'); interDiv.id='interstitialBox'; interDiv.style.display='none'; document.body.appendChild(interDiv); } else interDiv.innerHTML='';
  // inject user-provided interstitial script
  interDiv.innerHTML = "<script type='text/javascript' src='//pl28156315.effectivegatecpm.com/b0/b1/55/b0b1558127916e4719db92df414595d2.js'><\\/script>";
  if(interstitialTimeout) clearTimeout(interstitialTimeout);
  interstitialTimeout = setTimeout(()=>{ interstitialTimeout=null; renderQR(pendingContent); pendingContent=''; interDiv.innerHTML=''; },3800);
}

// bind generate button
document.getElementById('makeQR').addEventListener('click', async ()=>{
  qrMsg.textContent=''; pendingContent=''; qrDataURL=''; thank.style.display='none';
  const text = (document.getElementById('qrText').value||'').trim();
  const fileEl = document.getElementById('qrFile');
  if(!text && (!fileEl || fileEl.files.length===0)){ qrMsg.textContent='Enter text or upload file.'; return; }
  if(fileEl && fileEl.files.length){
    try{ qrMsg.textContent='Preparing file...'; const data = await readFileAsDataURL(fileEl.files[0]); if(data.length>1800){ pendingContent = `File: ${fileEl.files[0].name}`; qrMsg.textContent='File too large ‚Äî encoding filename only.'; } else pendingContent = data; }catch(e){ qrMsg.textContent='File read error.'; return; }
  } else pendingContent = text;
  qrMsg.textContent='Showing ad...';
  showInterstitialThenGenerate();
});

// download button (robust fallback)
document.getElementById('downloadQR').addEventListener('click', ()=>{
  if(!qrDataURL){
    const img = qrPreview.querySelector('img');
    if(img && img.src){ window.open(img.src,'_blank'); return; }
    qrMsg.textContent = 'No QR to download. Generate first.';
    return;
  }
  const a = document.createElement('a'); a.href = qrDataURL; a.download = 'toolbox-qr.png'; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>{ window.open(qrDataURL,'_blank'); }, 600);
});

/* cleanup interstitial container periodically */
setInterval(()=>{ const el=document.getElementById('interstitialBox'); if(el && Date.now()%60000 < 500) el.innerHTML=''; },60000);

</script>
</body>
</html>